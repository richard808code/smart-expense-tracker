<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Smart Expense Tracker</title>

    <!-- SB Admin 2 CSS -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet"/>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet"/>
</head>

<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <div class="sidebar-brand-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Smart Expense</div>
        </a>

        <hr class="sidebar-divider my-0"/>

        <li class="nav-item active" id="nav-item-dashboard">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-tachometer-alt"></i><span>Dashboard</span></a>
        </li>

        <hr class="sidebar-divider"/>

        <li class="nav-item" id="nav-item-users">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-user"></i><span>Users</span></a>
        </li>

        <li class="nav-item" id="nav-item-categories">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-list"></i><span>Categories</span></a>
        </li>

        <li class="nav-item" id="nav-item-budgets">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-file-invoice-dollar"></i><span>Budgets</span></a>
        </li>

        <li class="nav-item" id="nav-item-transactions">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-exchange-alt"></i><span>Transactions</span></a>
        </li>

        <hr class="sidebar-divider d-none d-md-block"/>
    </ul>
    <!-- End of Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div id="current-user-display" style="position: absolute; top: 10px; right: 20px; font-weight: bold;">
                Current User: <span id="current-username">None</span>
            </div>
            <div class="container-fluid py-4">

                <div id="dashboard-section">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Budget Limit Control</h6>
                                </div>
                                <div class="card-body" id="budget-progress-bars">
                                    <!-- Progress bary se sem vloží dynamicky -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="users-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Users</h1>
                    <input type="text" id="new-user-username" placeholder="Username" class="form-control mb-2"/>
                    <button id="add-user-button" class="btn btn-primary mb-3" onclick="addUser()">Add User</button>

                    <div id="edit-user-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-user-username" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditUser()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditUser()">Cancel</button>
                    </div>

                    <table class="table table-bordered" id="users-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="budgets-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Budgets</h1>

                    <!-- Add Budget Form -->
                    <div id="add-budget-form" style="margin-bottom: 20px;">
                        <input type="text" id="new-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="new-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button id="add-budget-button" class="btn btn-primary mb-3" onclick="addBudget()">Add Budget</button>
                    </div>

                    <!-- Edit Budget Form -->
                    <div id="edit-budget-form" style="display:none; margin-bottom: 20px;">
                        <input type="text" id="edit-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="edit-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="edit-budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button class="btn btn-success" onclick="submitEditBudget()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditBudget()">Cancel</button>
                    </div>

                    <!-- Budgets Table -->
                    <table class="table table-bordered" id="budgets-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Budget Name</th>
                            <th>Limit</th>
                            <th>Category Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="categories-section" style="display: none;">
                    <h2>Categories</h2>


                    <div>
                        <input type="text" id="new-category-name" placeholder="Category name" class="form-control mb-2" />
                        <button id="add-category-button" class="btn btn-primary mb-3" onclick="addCategory()">Add Category</button>
                    </div>

                    <div id="edit-category-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-category-name" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditCategory()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditCategory()">Cancel</button>
                    </div>


                    <table id="categories-table" class="table table-striped mt-3">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="transactions-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Transactions</h1>

                    <!-- Add Transaction Form -->
                    <div id="add-transaction-form" style="margin-bottom: 20px;">
                        <input type="number" id="new-transaction-amount" placeholder="Amount"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="-999999" step="0.01"/>
                        <input type="text" id="new-transaction-description" placeholder="Description"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <select id="transaction-budget-select" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <input type="datetime-local" id="new-transaction-date"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" />
                        <button id="add-transaction-button" class="btn btn-primary mb-3" onclick="addTransaction()">Add Transaction</button>
                    </div>

                    <!-- Edit Transaction Form -->
                    <div id="edit-transaction-form" style="display:none; margin-bottom: 20px;">
                        <input type="number" id="edit-transaction-amount" placeholder="Amount"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="-999999" step="0.01"/>
                        <input type="text" id="edit-transaction-description" placeholder="Description"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <select id="edit-transaction-budget-select" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <input type="datetime-local" id="edit-transaction-date"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" />
                        <button class="btn btn-success" onclick="submitEditTransaction()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTransaction()">Cancel</button>
                    </div>

                    <!-- Transactions Table -->
                    <table class="table table-bordered" id="transactions-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Transaction Description</th>
                            <th>Budget Name</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>

<script>
    // Sections and navigation Items elements
    const sections = ['dashboard-section', 'users-section', 'budgets-section', 'categories-section', 'transactions-section'];
    const navItems = ['nav-item-dashboard', 'nav-item-users', 'nav-item-budgets', 'nav-item-categories', 'nav-item-transactions'];


    // "Local Cache" for FrontEnd
    let users = [];
    let categories = [];
    let budgets = [];
    let transactions = [];

    //Save the currentUser in local storage for refreshing purposes
    let currentUserId = localStorage.getItem('currentUserId') || null;

    // ID of the item that`s being edited
    let editingUserId = null;
    let editingCategoryId = null;
    let editingBudgetId = null;
    let editingTransactionId = null;

    // Showing the chosen section and hiding the others
    function showSection(sectionId) {
        // Validate sectionId type and existence in sections array
        if (typeof sectionId !== 'string' || !sections.includes(sectionId)) {
            console.warn(`showSection: Invalid sectionId "${sectionId}"`);
            return;
        }

        // Show the chosen section and hide the others
        sections.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (id === sectionId) ? 'block' : 'none';
            } else {
                console.warn(`showSection: Element with id "${id}" not found in DOM.`);
            }
        });

        // Extract the prefix safely from sectionId
        const prefix = sectionId.split('-')[0] || '';

        // Highlight the active navigation item
        navItems.forEach(navId => {
            const navEl = document.getElementById(navId);
            if (navEl) {
                navEl.classList.toggle(
                    'active',
                    navId === 'nav-item-' + prefix
                );
            } else {
                console.warn(`showSection: Navigation element with id "${navId}" not found in DOM.`);
            }
        });
    }

    // Listeners for the sidebar (with validation)
    const sidebarLinks = document.querySelectorAll('#accordionSidebar .nav-link');

    if (!sidebarLinks || sidebarLinks.length === 0) {
        console.warn('Sidebar links not found');
    } else {
        sidebarLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();

                const span = link.querySelector('span');
                if (!span) {
                    console.warn('Sidebar link span element missing');
                    return;
                }

                const sectionName = span.textContent?.trim().toLowerCase();
                if (!sectionName) {
                    console.warn('Sidebar link section name missing or empty');
                    return;
                }

                switch (sectionName) {
                    case 'dashboard':
                        showSection('dashboard-section');
                        break;
                    case 'users':
                        showSection('users-section');
                        loadUsers();
                        break;
                    case 'budgets':
                        showSection('budgets-section');
                        loadBudgets();
                        break;
                    case 'categories':
                        showSection('categories-section');
                        loadCategories();
                        break;
                    case 'transactions':
                        showSection('transactions-section');
                        loadTransactions();
                        break;
                    default:
                        console.warn(`Unknown section name: ${sectionName}`);
                }
            });
        });
    }

    // --- USERS ---

    async function loadUsers() {
        try {
            // Fetch the list of users from the API
            const response = await fetch('http://localhost:8080/api/users');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Parse response JSON into the users array
            users = await response.json();

            // Find the table body element where users will be displayed
            const tbody = document.querySelector('#users-table tbody');
            if (!tbody) {
                console.warn('Table body for users not found');
                return;
            }
            tbody.innerHTML = ''; // Clear existing rows

            // Loop through each user and create table rows
            users.forEach(user => {
                // Basic validation: check required properties
                if (!user || typeof user.id === 'undefined' || !user.username) {
                    console.warn('Skipping invalid user entry:', user);
                    return;
                }

                // Create table row with user details and action buttons
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" onclick="editUser('${user.id}', '${user.username}')">Edit</button>
                    <button class="btn btn-sm btn-secondary me-1" onclick="changeCurrentUser('${user.id}')">Select</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                </td>
            `;

                // Append the row to the table body
                tbody.appendChild(row);
            });

            // If currentUserId is not set or no longer valid, set it to first user ID or null
            if (!currentUserId || !Array.isArray(users) || !users.some(u => u.id == currentUserId)) {
                currentUserId = Array.isArray(users) && users.length ? users[0].id : null;
                localStorage.setItem('currentUserId', currentUserId);
            }

            // Update UI to reflect current user and notify other parts of app
            updateCurrentUserDisplay();
            onCurrentUserChanged();

        } catch (error) {
            // Log any error encountered during fetching or rendering
            console.error('ERROR: Could not load the users:', error);
        }
    }

    async function addUser() {
        // Get and trim username input value
        const usernameInput = document.getElementById('new-user-username');
        const username = usernameInput ? usernameInput.value.trim() : '';

        // Validate input is not empty
        if (!username) {
            alert('Username cannot be empty.');
            return;
        }

        try {
            // Send POST request to add new user
            const response = await fetch('http://localhost:8080/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username })
            });

            // Check if response was successful
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Clear input field after successful addition
            if (usernameInput) {
                usernameInput.value = '';
            }

            // Reload users to update the list
            loadUsers();

        } catch (error) {
            console.error('ERROR: Could not add user:', error);
            alert('Failed to add user. Please try again.');
        }
    }

    async function deleteUser(id) {
        // Validate that id is provided
        if (!id) {
            console.warn('No user ID provided for deletion.');
            return;
        }

        // Confirm user wants to delete
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            // Send DELETE request to API for the specified user ID
            const response = await fetch(`http://localhost:8080/api/users/${id}`, { method: 'DELETE' });

            // Check if deletion was successful
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Reload users to update the list after deletion
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not delete user:', error);
            alert('Failed to delete user. Please try again.');
        }
    }

    function editUser(id, username) {
        // Set the editing user ID (used internally for updating)
        editingUserId = id;

        // Populate the username input field with the current username
        const editInput = document.getElementById('edit-user-username');
        if (editInput) {
            editInput.value = username;
        } else {
            console.warn('Edit input element not found.');
            return;
        }

        // Show the edit user form
        const editForm = document.getElementById('edit-user-form');
        if (editForm) {
            editForm.style.display = 'block';
        }

        // Hide the new user input and add button while editing
        const newUserInput = document.getElementById('new-user-username');
        if (newUserInput) newUserInput.style.display = 'none';

        const addUserButton = document.getElementById('add-user-button');
        if (addUserButton) addUserButton.style.display = 'none';
    }

    function cancelEditUser() {
        // Clear the editing user ID (exit edit mode)
        editingUserId = null;

        // Hide the edit form
        const editForm = document.getElementById('edit-user-form');
        if (editForm) editForm.style.display = 'none';

        // Show the new user input field
        const newUserInput = document.getElementById('new-user-username');
        if (newUserInput) newUserInput.style.display = 'block';

        // Show the add user button
        const addUserButton = document.getElementById('add-user-button');
        if (addUserButton) addUserButton.style.display = 'inline-block';
    }

    async function submitEditUser() {
        // Get the new username from the edit field
        const newUsername = document.getElementById('edit-user-username').value.trim();

        // If no username provided or no user is being edited, stop
        if (!newUsername || !editingUserId) return;

        try {
            // Send PUT request to update the user
            await fetch(`http://localhost:8080/api/users/${editingUserId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: newUsername })
            });

            // Exit edit mode and reload user list
            cancelEditUser();
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not edit user:', error);
        }
    }

    function updateCurrentUserDisplay() {
        // Find the current user by ID
        const user = users.find(u => u.id == currentUserId);

        // Update the display element with the username or 'None' if not found
        const currentUsernameElement = document.getElementById('current-username');
        if (currentUsernameElement) {
            currentUsernameElement.textContent = user ? user.username : 'None';
        }
    }

    function changeCurrentUser(id) {
        // Update the current user ID in memory
        currentUserId = id;

        // Save the current user ID to localStorage for persistence
        localStorage.setItem('currentUserId', id);

        // Update the UI display with the new user's information
        updateCurrentUserDisplay();

        // Call a function to handle any additional logic when the user changes
        onCurrentUserChanged();
    }

    // --- CATEGORIES ---

    async function loadCategories() {
        // Check if a current user is selected
        if (!currentUserId) {
            clearCategoriesUI();
            return;
        }

        try {
            // Fetch categories for the current user
            const response = await fetch(`http://localhost:8080/api/categories/user/${currentUserId}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch categories: ${response.status} ${response.statusText}`);
            }

            categories = await response.json();

            // Find the table body element for categories
            const tbody = document.querySelector('#categories-table tbody');
            if (!tbody) {
                throw new Error('Categories table body element not found');
            }
            tbody.innerHTML = ''; // Clear existing rows

            // Loop through each category and create table rows
            categories.forEach(cat => {
                if (!cat || typeof cat.id === 'undefined' || !cat.name) {
                    console.warn('Skipping invalid category entry:', cat);
                    return;
                }

                // Escape single quotes for safe HTML usage
                const safeName = cat.name.replace(/'/g, "\\'");

                // Create a table row with buttons styled like transactions/users
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${cat.id}</td>
                <td>${cat.name}</td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" onclick="editCategory('${cat.id}', '${safeName}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory('${cat.id}')">Delete</button>
                </td>
            `;

                tbody.appendChild(row);
            });

            // Update any category selects or related UI elements
            fillCategorySelects();

        } catch (error) {
            // Log errors during fetch or rendering
            console.error('ERROR: Could not load categories:', error);
        }
    }

    function clearCategoriesUI() {
        // Clear the categories table body content
        const tbody = document.querySelector('#categories-table tbody');
        if (tbody) tbody.innerHTML = '';

        // Clear the budget category select options
        const budgetCategorySelect = document.getElementById('budget-category');
        if (budgetCategorySelect) budgetCategorySelect.innerHTML = '';

        // Clear the edit budget category select options
        const editBudgetCategorySelect = document.getElementById('edit-budget-category');
        if (editBudgetCategorySelect) editBudgetCategorySelect.innerHTML = '';
    }

    function fillCategorySelects() {
        // Get the select elements for adding and editing budgets
        const addSelect = document.getElementById('budget-category');
        const editSelect = document.getElementById('edit-budget-category');

        // Validate that the select elements exist before proceeding
        if (!addSelect || !editSelect) {
            console.error('ERROR: Category select elements not found.');
            return;
        }

        // Clear existing options
        addSelect.innerHTML = '';
        editSelect.innerHTML = '';

        // Populate both selects with current categories
        categories.forEach(cat => {
            // Create option for addSelect
            const option1 = document.createElement('option');
            option1.value = cat.id;
            option1.textContent = cat.name;
            addSelect.appendChild(option1);

            // Clone the option for editSelect
            const option2 = option1.cloneNode(true);
            editSelect.appendChild(option2);
        });
    }

    async function addCategory() {
        // Get the new category name from input and trim whitespace
        const name = document.getElementById('new-category-name')?.value.trim();

        // Validate that name is not empty and currentUserId is set
        if (!name) {
            console.warn('WARNING: Category name is empty.');
            return;
        }
        if (!currentUserId) {
            console.error('ERROR: No current user selected.');
            return;
        }

        try {
            // Send POST request to add a new category
            await fetch('http://localhost:8080/api/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, user: { id: currentUserId } })
            });

            // Clear input after successful add
            document.getElementById('new-category-name').value = '';

            // Reload categories to update UI
            loadCategories();
        } catch (error) {
            console.error('ERROR: Could not add category:', error);
        }
    }

    async function deleteCategory(id) {
        // Confirm user really wants to delete the category
        if (!id) {
            console.warn('WARNING: No category ID provided for deletion.');
            return;
        }
        if (!confirm('Are you sure you want to delete this category?')) return;

        try {
            // Send DELETE request to backend to remove the category by id
            await fetch(`http://localhost:8080/api/categories/${id}`, { method: 'DELETE' });

            // Reload categories list after successful deletion
            loadCategories();
        } catch (error) {
            // Log any errors during the deletion process
            console.error('ERROR: Could not delete category:', error);
        }
    }

    function editCategory(id, name) {
        // Store the ID of the category being edited
        editingCategoryId = id;

        // Pre-fill the edit form input with the current category name
        document.getElementById('edit-category-name').value = name;

        // Show the edit category form
        document.getElementById('edit-category-form').style.display = 'block';

        // Hide the new category input field
        document.getElementById('new-category-name').style.display = 'none';

        // Hide the add category button
        document.getElementById('add-category-button').style.display = 'none';
    }

    function cancelEditCategory() {
        // Reset the editing category ID since editing is canceled
        editingCategoryId = null;

        // Hide the edit category form
        document.getElementById('edit-category-form').style.display = 'none';

        // Show the new category input field
        document.getElementById('new-category-name').style.display = 'block';

        // Show the add category button
        document.getElementById('add-category-button').style.display = 'inline-block';
    }

    async function submitEditCategory() {
        // Get the trimmed new category name from input
        const newName = document.getElementById('edit-category-name').value.trim();

        // Return early if no name or no category is currently being edited
        if (!newName || !editingCategoryId) return;

        try {
            // Send PUT request to update category on backend
            await fetch(`http://localhost:8080/api/categories/${editingCategoryId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: newName, user: { id: currentUserId } })
            });

            // Cancel edit mode and reload categories list
            cancelEditCategory();
            loadCategories();
        } catch (error) {
            // Log any errors during the update
            console.error('ERROR: Could not edit category:', error);
        }
    }

    // --- BUDGETS ---

    async function loadBudgets() {
        // Check if a current user is selected
        if (!currentUserId) {
            clearBudgetsUi();
            return;
        }

        try {
            // Fetch budgets for the current user
            const response = await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch budgets: ${response.status} ${response.statusText}`);
            }

            budgets = await response.json();

            // Find the table body element for budgets
            const tbody = document.querySelector('#budgets-table tbody');
            if (!tbody) {
                throw new Error('Budgets table body element not found');
            }
            tbody.innerHTML = ''; // Clear existing rows

            // Loop through each budget and create table rows
            budgets.forEach(budget => {
                if (!budget || typeof budget.id === 'undefined' || !budget.name) {
                    console.warn('Skipping invalid budget entry:', budget);
                    return;
                }

                const categoryName = budget.category && budget.category.name ? budget.category.name : 'N/A';
                const safeName = budget.name.replace(/'/g, "\\'");

                // Create a table row with buttons styled like transactions/users
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${budget.id}</td>
                <td>${safeName}</td>
                <td>${budget.limitAmount}</td>
                <td>${categoryName}</td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" onclick="editBudget('${budget.id}', '${safeName}', ${budget.limitAmount}, '${budget.category ? budget.category.id : ''}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBudget('${budget.id}')">Delete</button>
                </td>
            `;

                tbody.appendChild(row);
            });

            // Update budget selects or other related UI elements
            fillBudgetSelects();

        } catch (error) {
            // Log errors during fetch or rendering
            console.error('ERROR: Could not load budgets:', error);
        }
    }

    function clearBudgetsUi() {
        // Clear all budget rows from the table body
        document.querySelector('#budgets-table tbody').innerHTML = '';
    }

    function fillBudgetSelects() {
        const addSelect = document.getElementById('transaction-budget-select');
        const editSelect = document.getElementById('edit-transaction-budget-select');

        if (!addSelect || !editSelect) {
            console.error('ERROR: Budget select elements not found.');
            return;
        }

        addSelect.innerHTML = '';
        editSelect.innerHTML = '';

        budgets.forEach(budget => {
            const option1 = document.createElement('option');
            option1.value = budget.id;
            option1.textContent = budget.name;
            addSelect.appendChild(option1);

            const option2 = option1.cloneNode(true);
            editSelect.appendChild(option2);
        });
    }

    async function addBudget() {
        const name = document.getElementById('new-budget-name').value.trim();
        const limitAmount = parseFloat(document.getElementById('new-budget-limit').value);
        const categoryId = document.getElementById('budget-category').value;

        // Validate required fields and values
        if (!name || isNaN(limitAmount) || !categoryId || !currentUserId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        // Ensure limit is positive
        if (limitAmount <= 0) {
            alert('Budget limit must be greater than 0.');
            return;
        }

        try {
            // Send POST request to create a new budget for the current user
            await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId },
                    user: { id: currentUserId }
                })
            });

            // Clear the input form after successful addition
            clearBudgetAddForm();

            // Reload budgets to reflect changes
            loadBudgets();

            // Reload budget options in transaction selects
            await loadBudgetsForTransactionSelect('transaction-budget-select');
            await loadBudgetsForTransactionSelect('edit-transaction-budget-select');

        } catch (error) {
            console.error('ERROR: Could not add budget:', error);
        }
    }

    function clearBudgetAddForm() {
        // Reset the budget name input field
        document.getElementById('new-budget-name').value = '';

        // Reset the budget limit input field
        document.getElementById('new-budget-limit').value = '';

        // Reset category dropdown to the first option
        document.getElementById('budget-category').selectedIndex = 0;
    }


    async function deleteBudget(id) {
        // Basic validation: ensure ID is provided
        if (!id) {
            console.warn('No budget ID provided for deletion.');
            return;
        }

        // Ask the user to confirm the deletion action
        if (!confirm('Are you sure you want to delete this budget?')) return;

        try {
            // Send DELETE request to backend to remove budget by ID
            await fetch(`http://localhost:8080/api/budgets/${id}`, { method: 'DELETE' });

            // Reload budgets to update the UI after deletion
            loadBudgets();
        } catch (error) {
            // Log any errors for debugging
            console.error('ERROR: Could not delete budget:', error);
        }
    }

    function editBudget(id, name, limitAmount, categoryId) {
        // Set the global editing budget ID to the one provided
        editingBudgetId = id;

        // Fill the edit form inputs with the current budget data
        document.getElementById('edit-budget-name').value = name;
        document.getElementById('edit-budget-limit').value = limitAmount;
        document.getElementById('edit-budget-category').value = categoryId;

        // Show the edit form and hide the add budget form
        document.getElementById('edit-budget-form').style.display = 'block';
        document.getElementById('add-budget-form').style.display = 'none';
    }

    function cancelEditBudget() {
        // Reset the editing budget ID to null to indicate no budget is being edited
        editingBudgetId = null;

        // Hide the edit budget form
        document.getElementById('edit-budget-form').style.display = 'none';

        // Show the add budget form again
        document.getElementById('add-budget-form').style.display = 'block';
    }

    async function submitEditBudget() {
        // Get the trimmed name value from the edit form input
        const name = document.getElementById('edit-budget-name').value.trim();

        // Parse the limit amount input value to a float
        const limitAmount = parseFloat(document.getElementById('edit-budget-limit').value);

        // Get the selected category ID from the edit form select
        const categoryId = document.getElementById('edit-budget-category').value;

        // Validate all fields: name must not be empty, limitAmount must be a number,
        // categoryId must be selected, and editingBudgetId must be set
        if (!name || isNaN(limitAmount) || !categoryId || !editingBudgetId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        try {
            // Send PUT request to update the budget on the backend
            await fetch(`http://localhost:8080/api/budgets/${editingBudgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId }
                })
            });

            // Cancel editing mode and reload budgets to refresh UI
            cancelEditBudget();
            loadBudgets();

        } catch (error) {
            // Log error if request fails
            console.error('ERROR: Could not edit budget:', error);
        }
    }

    //Transactions

    async function loadTransactions() {
        // Check if currentUserId is set; if not, clear transactions UI and exit
        if (!currentUserId) {
            clearTransactionsUi();
            return;
        }

        try {
            // Fetch transactions for the current user from API endpoint
            const response = await fetch(`http://localhost:8080/api/transactions/user/${currentUserId}`);

            // Check if response status is OK (status code 200-299)
            if (!response.ok) {
                console.error(`Failed to load transactions: ${response.status} ${response.statusText}`);
                return;
            }

            // Parse JSON body from the response
            transactions = await response.json();

            // Select the transactions table body and clear existing rows
            const tbody = document.querySelector('#transactions-table tbody');
            tbody.innerHTML = '';

            // Loop through each transaction and create table rows
            transactions.forEach(t => {
                // Basic validation: check required properties
                if (!t || typeof t.id === 'undefined' || typeof t.amount !== 'number' || !t.date) {
                    console.warn('Skipping invalid transaction entry:', t);
                    return;
                }

                // Get budget name if available, fallback to 'N/A'
                const budgetName = t.budget && t.budget.name ? t.budget.name : 'N/A';

                // Create table row with transaction details and action buttons
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${t.id}</td>
                <td>${t.amount.toFixed(2)}</td>
                <td>${t.description || ''}</td>
                <td>${budgetName}</td>
                <td>${t.date}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editTransaction('${t.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${t.id}')">Delete</button>
                </td>
            `;

                // Append the row to the table body
                tbody.appendChild(row);
            });
        } catch (error) {
            // Log any error encountered during fetching or rendering
            console.error('ERROR: Could not load transactions:', error);
        }
    }

    // Clears the transactions table body to remove all existing rows from the UI
    function clearTransactionsUi() {
        document.querySelector('#transactions-table tbody').innerHTML = '';
    }

    // Adds a new transaction after validating inputs, then reloads transactions from backend
    async function addTransaction() {
        // Get input values from the form
        const amount = parseFloat(document.getElementById('new-transaction-amount').value);
        const description = document.getElementById('new-transaction-description').value.trim();
        const budgetId = document.getElementById('transaction-budget-select').value;
        const date = document.getElementById('new-transaction-date').value;

        // Basic validation: check for empty fields, zero amount, invalid date, and missing IDs
        if (isNaN(amount) || amount === 0 || description === '' || !date || !budgetId || !currentUserId) {
            alert('Please fill all fields correctly, including date and budget.');
            return; // Stop if validation fails
        }

        try {
            // Send POST request to backend API to add the new transaction
            const res = await fetch(`http://localhost:8080/api/transactions/user/${currentUserId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    amount,
                    description,
                    budget: { id: budgetId },
                    user: { id: currentUserId },
                    date
                })
            });

            // If response is not OK, throw error to catch block
            if (!res.ok) throw new Error('Failed to add transaction');

            // On success, reload transactions to update the UI
            await loadTransactions();

            // Clear the add transaction form fields
            clearTransactionAddForm();

            // Reload budgets with remaining amounts to update budget info if needed
            loadBudgetsWithRemaining();
        } catch (e) {
            // Show error alert if adding transaction fails
            alert(e.message);
        }
    }

    function clearTransactionAddForm() {
        // Clear the amount input field for new transaction
        document.getElementById('new-transaction-amount').value = '';
        // Clear the description input field for new transaction
        document.getElementById('new-transaction-description').value = '';
        // Reset the budget dropdown to the first option
        document.getElementById('transaction-budget-select').selectedIndex = 0;
    }


    // Prepares the edit transaction form by loading the transaction data into the inputs
    async function editTransaction(id) {
        // Find the transaction in the current list by ID
        const t = transactions.find(tr => tr.id === id);
        if (!t) return; // If not found, exit early

        // Store the ID of the transaction currently being edited
        editingTransactionId = id;

        // Fill the edit form inputs with existing transaction data
        document.getElementById('edit-transaction-amount').value = t.amount;
        document.getElementById('edit-transaction-description').value = t.description;


        // Set the budget select to the current transaction's budget
        document.getElementById('edit-transaction-budget-select').value = t.budget.id;

        // Hide the add transaction form and show the edit transaction form
        document.getElementById('add-transaction-form').style.display = 'none';
        document.getElementById('edit-transaction-form').style.display = 'block';
    }


    async function submitEditTransaction() {
        // Parse amount from input and trim description
        const amount = parseFloat(document.getElementById('edit-transaction-amount').value);
        const description = document.getElementById('edit-transaction-description').value.trim();
        const budgetId = document.getElementById('edit-transaction-budget-select').value;
        const date = document.getElementById('edit-transaction-date').value;

        // Validate inputs: amount must be a number and not zero, description and date required, editingTransactionId must be set
        if (isNaN(amount) || amount === 0 || description === '' || !date || !editingTransactionId) {
            alert('Please enter valid amount (non-zero), description, date, and make sure transaction ID is set.');
            return;
        }

        // Prepare data object to send to backend API
        const bodyData = {
            amount,
            description,
            budget: { id: budgetId },
            user: { id: currentUserId },
            date
        };

        try {
            // Send PUT request to update transaction by its ID
            const res = await fetch(`http://localhost:8080/api/transactions/${editingTransactionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });

            // If response is not OK, throw error with server message
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`Failed to update transaction. Server responded: ${text}`);
            }

            // Parse updated transaction from response
            const updatedTransaction = await res.json();

            // Find the edited transaction in local array and update it
            const idx = transactions.findIndex(t => t.id === editingTransactionId);
            if (idx >= 0) {
                transactions[idx] = updatedTransaction;
                loadTransactions();      // Reload transactions list to refresh UI
                cancelEditTransaction(); // Hide edit form and show add form again
            }
        } catch (e) {
            alert(e.message);          // Show error alert if fetch or update fails
        }
    }

    // Resets the editing state and switches the UI back to the add transaction form.
    function cancelEditTransaction() {
        editingTransactionId = null;
        document.getElementById('edit-transaction-form').style.display = 'none';
        document.getElementById('add-transaction-form').style.display = 'block';
    }


    // Asks for confirmation and deletes the transaction by ID if confirmed
    // Then updates the local transactions array and reloads the transaction list
    async function deleteTransaction(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;

        try {
            const res = await fetch(`http://localhost:8080/api/transactions/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete transaction');

            // Remove deleted transaction from local array
            transactions = transactions.filter(t => t.id !== id);

            // Reload transactions to update the UI
            loadTransactions();
        } catch (e) {
            alert(e.message);
        }
    }

    //---Dashboard---

    // Renders progress bars showing budget usage for each budget item
    function renderBudgetProgressBars(budgets) {
        const container = document.getElementById('budget-progress-bars');
        container.innerHTML = ''; // Clear existing progress bars

        budgets.forEach(budget => {
            // Calculate the amount spent and percentage of budget used
            const spent = budget.limitAmount - budget.remainingAmount;
            const percent = Math.min((spent / budget.limitAmount) * 100, 100).toFixed(0);

            // Choose progress bar color based on percentage used
            // green if under 70%, yellow if between 70% and 100%, red if 100% or more
            const color = percent < 70 ? 'bg-success' : percent < 100 ? 'bg-warning' : 'bg-danger';

            // Build the progress bar HTML string
            const progressBar = `
      <h4 class="small font-weight-bold">
        ${budget.name} — <small class="text-muted">${budget.category.name}</small>
        <span class="float-right">
          ${spent.toFixed(2)} Kč / ${budget.limitAmount.toFixed(2)} Kč
        </span>
      </h4>
      <div class="progress mb-4">
        <div class="progress-bar ${color}" role="progressbar"
             style="width: ${percent}%" aria-valuenow="${percent}"
             aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    `;

            // Append the progress bar to the container
            container.innerHTML += progressBar;
        });
    }

    // Loads budgets with their remaining amounts for the current user from the backend
    // Then calls the function to render progress bars showing budget usage
    async function loadBudgetsWithRemaining() {
        if (!currentUserId) {
            console.error('currentUserId is not set');
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/budgets/remaining?userId=${currentUserId}`);
            if (!response.ok) throw new Error('Error loading budgets');
            const budgets = await response.json();

            console.log('Budgets with remaining:', budgets);
            renderBudgetProgressBars(budgets);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // After the page content loads, call loadBudgetsWithRemaining once
    // Then refresh the budgets every 10 seconds to keep data up-to-date
    document.addEventListener('DOMContentLoaded', () => {
        loadBudgetsWithRemaining();
        setInterval(loadBudgetsWithRemaining, 10000);
    });


    // Called when the current user changes to reload all related data on the page
    async function onCurrentUserChanged() {
        loadCategories();
        loadBudgets();
        loadTransactions();
        fillCategorySelects();
        fillBudgetSelects();
        loadBudgetsWithRemaining();
    }

    // When the window finishes loading, show the dashboard section and load the users
    window.onload = async () => {
        showSection('dashboard-section');
        await loadUsers();
    };
</script>
</body>
</html>