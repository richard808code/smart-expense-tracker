<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Smart Expense Tracker</title>

    <!-- SB Admin 2 CSS -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet"/>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet"/>
</head>

<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <div class="sidebar-brand-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Smart Expense</div>
        </a>

        <hr class="sidebar-divider my-0"/>

        <li class="nav-item active" id="nav-item-dashboard">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-tachometer-alt"></i><span>Dashboard</span></a>
        </li>

        <hr class="sidebar-divider"/>

        <li class="nav-item" id="nav-item-users">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-user"></i><span>Users</span></a>
        </li>

        <li class="nav-item" id="nav-item-categories">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-list"></i><span>Categories</span></a>
        </li>

        <li class="nav-item" id="nav-item-budgets">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-file-invoice-dollar"></i><span>Budgets</span></a>
        </li>

        <li class="nav-item" id="nav-item-transactions">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-exchange-alt"></i><span>Transactions</span></a>
        </li>

        <hr class="sidebar-divider d-none d-md-block"/>
    </ul>
    <!-- End of Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div id="current-user-display" style="position: absolute; top: 10px; right: 20px; font-weight: bold;">
                Current User: <span id="current-username">None</span>
            </div>
            <div class="container-fluid py-4">

                <div id="dashboard-section">
                    <h1 class="h3 mb-4 text-gray-800">Dashboard</h1>
                    <p>This is the Dashboard placeholder content.</p>
                </div>

                <div id="users-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Users</h1>
                    <input type="text" id="new-user-username" placeholder="Username" class="form-control mb-2"/>
                    <button id="add-user-button" class="btn btn-primary mb-3" onclick="addUser()">Add User</button>

                    <div id="edit-user-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-user-username" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditUser()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                    </div>

                    <table class="table table-bordered" id="users-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="budgets-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Budgets</h1>

                    <!-- Add Budget Form -->
                    <div id="add-budget-form" style="margin-bottom: 20px;">
                        <input type="text" id="new-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="new-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button id="add-budget-button" class="btn btn-primary mb-3" onclick="addBudget()">Add Budget</button>
                    </div>

                    <!-- Edit Budget Form -->
                    <div id="edit-budget-form" style="display:none; margin-bottom: 20px;">
                        <input type="text" id="edit-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="edit-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="edit-budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button class="btn btn-success" onclick="submitEditBudget()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditBudget()">Cancel</button>
                    </div>

                    <!-- Budgets Table -->
                    <table class="table table-bordered" id="budgets-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Budget Name</th>
                            <th>Limit</th>
                            <th>Category Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="categories-section" style="display: none;">
                    <h2>Categories</h2>


                    <div>
                        <input type="text" id="new-category-name" placeholder="Category name" class="form-control mb-2" />
                        <button id="add-category-button" class="btn btn-primary mb-3" onclick="addCategory()">Add Category</button>
                    </div>

                    <div id="edit-category-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-category-name" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditCategory()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditCategory()">Cancel</button>
                    </div>


                    <table id="categories-table" class="table table-striped mt-3">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="transactions-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Transactions</h1>
                    <p>This is the Transactions section placeholder content.</p>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>

<script>
    // Sekce a navigační položky
    const sections = ['dashboard-section', 'users-section', 'budgets-section', 'categories-section', 'transactions-section'];
    const navItems = ['nav-item-dashboard', 'nav-item-users', 'nav-item-budgets', 'nav-item-categories', 'nav-item-transactions'];

    let users = [];
    let categories = [];
    let budgets = [];
    let currentUserId = localStorage.getItem('currentUserId') || null;

    let editingUserId = null;
    let editingCategoryId = null;
    let editingBudgetId = null;

    // Zobrazení požadované sekce
    function showSection(sectionId) {
        sections.forEach(id => {
            document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
        });
        navItems.forEach(navId => {
            document.getElementById(navId).classList.toggle('active', navId === 'nav-item-' + sectionId.split('-')[0]);
        });
    }

    // Nastavení posluchačů kliknutí v sidebaru
    document.querySelectorAll('#accordionSidebar .nav-link').forEach(link => {
        link.addEventListener('click', e => {
            e.preventDefault();
            const sectionName = link.querySelector('span').textContent.trim().toLowerCase();
            switch (sectionName) {
                case 'dashboard':
                    showSection('dashboard-section');
                    break;
                case 'users':
                    showSection('users-section');
                    loadUsers();
                    break;
                case 'budgets':
                    showSection('budgets-section');
                    loadBudgets();
                    break;
                case 'categories':
                    showSection('categories-section');
                    loadCategories();
                    break;
                case 'transactions':
                    showSection('transactions-section');
                    break;
            }
        });
    });

    // --- USERS ---

    async function loadUsers() {
        try {
            const response = await fetch('http://localhost:8080/api/users');
            users = await response.json();

            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const safeUsername = user.username.replace(/'/g, "\\'");
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                        <button onclick="editUser('${user.id}', '${safeUsername}')">Edit</button>
                        <button onclick="changeCurrentUser('${user.id}')">Select</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (!currentUserId || !users.some(u => u.id == currentUserId)) {
                currentUserId = users.length ? users[0].id : null;
                localStorage.setItem('currentUserId', currentUserId);
            }

            updateCurrentUserDisplay();
            onCurrentUserChanged();
        } catch (error) {
            console.error('ERROR: Could not load the users:', error);
        }
    }

    async function addUser() {
        const username = document.getElementById('new-user-username').value.trim();
        if (!username) return;

        try {
            await fetch('http://localhost:8080/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username })
            });
            document.getElementById('new-user-username').value = '';
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not add user:', error);
        }
    }

    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            await fetch(`http://localhost:8080/api/users/${id}`, { method: 'DELETE' });
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not delete user:', error);
        }
    }

    function editUser(id, username) {
        editingUserId = id;
        document.getElementById('edit-user-username').value = username;
        document.getElementById('edit-user-form').style.display = 'block';
        document.getElementById('new-user-username').style.display = 'none';
        document.getElementById('add-user-button').style.display = 'none';
    }

    function cancelEdit() {
        editingUserId = null;
        document.getElementById('edit-user-form').style.display = 'none';
        document.getElementById('new-user-username').style.display = 'block';
        document.getElementById('add-user-button').style.display = 'inline-block';
    }

    async function submitEditUser() {
        const newUsername = document.getElementById('edit-user-username').value.trim();
        if (!newUsername || !editingUserId) return;

        try {
            await fetch(`http://localhost:8080/api/users/${editingUserId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: newUsername })
            });
            cancelEdit();
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not edit user:', error);
        }
    }

    function updateCurrentUserDisplay() {
        const user = users.find(u => u.id == currentUserId);
        document.getElementById('current-username').textContent = user ? user.username : 'None';
    }

    function changeCurrentUser(id) {
        currentUserId = id;
        localStorage.setItem('currentUserId', id);
        updateCurrentUserDisplay();
        onCurrentUserChanged();
    }

    // --- CATEGORIES ---

    async function loadCategories() {
        if (!currentUserId) {
            clearCategoriesUI();
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/categories/user/${currentUserId}`);
            categories = await response.json();

            const tbody = document.querySelector('#categories-table tbody');
            tbody.innerHTML = '';

            categories.forEach(cat => {
                const safeName = cat.name.replace(/'/g, "\\'");
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cat.id}</td>
                    <td>${cat.name}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteCategory('${cat.id}')">Delete</button>
                        <button onclick="editCategory('${cat.id}', '${safeName}')">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            fillCategorySelects();
        } catch (error) {
            console.error('ERROR: Could not load categories:', error);
        }
    }

    function clearCategoriesUI() {
        document.querySelector('#categories-table tbody').innerHTML = '';
        document.getElementById('budget-category').innerHTML = '';
        document.getElementById('edit-budget-category').innerHTML = '';
    }

    function fillCategorySelects() {
        const addSelect = document.getElementById('budget-category');
        const editSelect = document.getElementById('edit-budget-category');
        addSelect.innerHTML = '';
        editSelect.innerHTML = '';

        categories.forEach(cat => {
            const option1 = document.createElement('option');
            option1.value = cat.id;
            option1.textContent = cat.name;
            addSelect.appendChild(option1);

            const option2 = option1.cloneNode(true);
            editSelect.appendChild(option2);
        });
    }

    async function addCategory() {
        const name = document.getElementById('new-category-name').value.trim();
        if (!name || !currentUserId) return;

        try {
            await fetch('http://localhost:8080/api/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, user: { id: currentUserId } })
            });
            document.getElementById('new-category-name').value = '';
            loadCategories();
        } catch (error) {
            console.error('ERROR: Could not add category:', error);
        }
    }

    async function deleteCategory(id) {
        if (!confirm('Are you sure you want to delete this category?')) return;

        try {
            await fetch(`http://localhost:8080/api/categories/${id}`, { method: 'DELETE' });
            loadCategories();
        } catch (error) {
            console.error('ERROR: Could not delete category:', error);
        }
    }

    function editCategory(id, name) {
        editingCategoryId = id;
        document.getElementById('edit-category-name').value = name;
        document.getElementById('edit-category-form').style.display = 'block';
        document.getElementById('new-category-name').style.display = 'none';
        document.getElementById('add-category-button').style.display = 'none';
    }

    function cancelEditCategory() {
        editingCategoryId = null;
        document.getElementById('edit-category-form').style.display = 'none';
        document.getElementById('new-category-name').style.display = 'block';
        document.getElementById('add-category-button').style.display = 'inline-block';
    }

    async function submitEditCategory() {
        const newName = document.getElementById('edit-category-name').value.trim();
        if (!newName || !editingCategoryId) return;

        try {
            await fetch(`http://localhost:8080/api/categories/${editingCategoryId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: newName, user: { id: currentUserId } })
            });
            cancelEditCategory();
            loadCategories();
        } catch (error) {
            console.error('ERROR: Could not edit category:', error);
        }
    }

    // --- BUDGETS ---

    async function loadBudgets() {
        if (!currentUserId) {
            clearBudgetsUI();
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`);
            budgets = await response.json();

            console.log('Budgets loaded:', budgets); // pro kontrolu v konzoli

            const tbody = document.querySelector('#budgets-table tbody');
            tbody.innerHTML = '';

            budgets.forEach(budget => {
                // Ověření, zda category existuje a má name
                const categoryName = budget.category && budget.category.name ? budget.category.name : 'N/A';

                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${budget.id}</td>
                <td>${budget.name}</td>
                <td>${budget.limitAmount}</td>
                <td>${categoryName}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteBudget('${budget.id}')">Delete</button>
                    <button onclick="editBudget('${budget.id}', '${budget.name}', ${budget.limitAmount}, '${budget.category ? budget.category.id : ''}')">Edit</button>
                </td>
            `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('ERROR: Could not load budgets:', error);
        }
    }

    function clearBudgetsUI() {
        document.querySelector('#budgets-table tbody').innerHTML = '';
    }

    async function addBudget() {
        const name = document.getElementById('new-budget-name').value.trim();
        const limitAmount = parseFloat(document.getElementById('new-budget-limit').value);
        const categoryId = document.getElementById('budget-category').value;

        if (!name || isNaN(limitAmount) || !categoryId || !currentUserId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        try {
            await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId },
                    user: { id: currentUserId }
                })
            });
            clearBudgetForm();
            loadBudgets();
        } catch (error) {
            console.error('ERROR: Could not add budget:', error);
        }
    }

    function clearBudgetForm() {
        document.getElementById('new-budget-name').value = '';
        document.getElementById('new-budget-limit').value = '';
        document.getElementById('budget-category').selectedIndex = 0;
    }


    async function deleteBudget(id) {
        if (!confirm('Are you sure you want to delete this budget?')) return;

        try {
            await fetch(`http://localhost:8080/api/budgets/${id}`, { method: 'DELETE' });
            loadBudgets();
        } catch (error) {
            console.error('ERROR: Could not delete budget:', error);
        }
    }

    function editBudget(id, name, limitAmount, categoryId) {
        editingBudgetId = id;
        document.getElementById('edit-budget-name').value = name;
        document.getElementById('edit-budget-limit').value = limitAmount;
        document.getElementById('edit-budget-category').value = categoryId;

        document.getElementById('edit-budget-form').style.display = 'block';
        document.getElementById('add-budget-form').style.display = 'none';
    }

    function cancelEditBudget() {
        editingBudgetId = null;
        document.getElementById('edit-budget-form').style.display = 'none';
        document.getElementById('add-budget-form').style.display = 'block';
    }

    async function submitEditBudget() {
        const name = document.getElementById('edit-budget-name').value.trim();
        const limitAmount = parseFloat(document.getElementById('edit-budget-limit').value);
        const categoryId = document.getElementById('edit-budget-category').value;

        if (!name || isNaN(limitAmount) || !categoryId || !editingBudgetId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        try {
            await fetch(`http://localhost:8080/api/budgets/${editingBudgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId }
                })
            });
            cancelEditBudget();
            loadBudgets();
        } catch (error) {
            console.error('ERROR: Could not edit budget:', error);
        }
    }

    // Volá se vždy po změně currentUserId
    function onCurrentUserChanged() {
        loadCategories();
        loadBudgets();
        fillCategorySelects();
    }

    window.onload = () => {
        showSection('dashboard-section');
        loadUsers();
    };
</script>
</body>
</html>