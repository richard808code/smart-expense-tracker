<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Smart Expense Tracker</title>

    <!-- SB Admin 2 CSS -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet"/>
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet"/>
</head>

<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
            <div class="sidebar-brand-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="sidebar-brand-text mx-3">Smart Expense</div>
        </a>

        <hr class="sidebar-divider my-0"/>

        <li class="nav-item active" id="nav-item-dashboard">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-tachometer-alt"></i><span>Dashboard</span></a>
        </li>

        <hr class="sidebar-divider"/>

        <li class="nav-item" id="nav-item-users">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-user"></i><span>Users</span></a>
        </li>

        <li class="nav-item" id="nav-item-categories">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-list"></i><span>Categories</span></a>
        </li>

        <li class="nav-item" id="nav-item-budgets">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-file-invoice-dollar"></i><span>Budgets</span></a>
        </li>

        <li class="nav-item" id="nav-item-transactions">
            <a class="nav-link" href="#"><i class="fas fa-fw fa-exchange-alt"></i><span>Transactions</span></a>
        </li>

        <hr class="sidebar-divider d-none d-md-block"/>
    </ul>
    <!-- End of Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div id="current-user-display" style="position: absolute; top: 10px; right: 20px; font-weight: bold;">
                Current User: <span id="current-username">None</span>
            </div>
            <div class="container-fluid py-4">

                <div id="dashboard-section">
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Budget Limit Control</h6>
                                </div>
                                <div class="card-body" id="budget-progress-bars">
                                    <!-- Progress bary se sem vloží dynamicky -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="users-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Users</h1>
                    <input type="text" id="new-user-username" placeholder="Username" class="form-control mb-2"/>
                    <button id="add-user-button" class="btn btn-primary mb-3" onclick="addUser()">Add User</button>

                    <div id="edit-user-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-user-username" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditUser()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditUser()">Cancel</button>
                    </div>

                    <table class="table table-bordered" id="users-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="budgets-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Budgets</h1>

                    <!-- Add Budget Form -->
                    <div id="add-budget-form" style="margin-bottom: 20px;">
                        <input type="text" id="new-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="new-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button id="add-budget-button" class="btn btn-primary mb-3" onclick="addBudget()">Add Budget</button>
                    </div>

                    <!-- Edit Budget Form -->
                    <div id="edit-budget-form" style="display:none; margin-bottom: 20px;">
                        <input type="text" id="edit-budget-name" placeholder="Budget name"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <input type="number" id="edit-budget-limit" placeholder="Budget limit"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <select id="edit-budget-category" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <button class="btn btn-success" onclick="submitEditBudget()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditBudget()">Cancel</button>
                    </div>

                    <!-- Budgets Table -->
                    <table class="table table-bordered" id="budgets-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Budget Name</th>
                            <th>Limit</th>
                            <th>Category Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="categories-section" style="display: none;">
                    <h2>Categories</h2>


                    <div>
                        <input type="text" id="new-category-name" placeholder="Category name" class="form-control mb-2" />
                        <button id="add-category-button" class="btn btn-primary mb-3" onclick="addCategory()">Add Category</button>
                    </div>

                    <div id="edit-category-form" style="display:none; margin-bottom:15px;">
                        <input type="text" id="edit-category-name" class="form-control mb-2" />
                        <button class="btn btn-success" onclick="submitEditCategory()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditCategory()">Cancel</button>
                    </div>


                    <table id="categories-table" class="table table-striped mt-3">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="transactions-section" style="display:none;">
                    <h1 class="h3 mb-4 text-gray-800">Transactions</h1>

                    <!-- Add Transaction Form -->
                    <div id="add-transaction-form" style="margin-bottom: 20px;">
                        <input type="number" id="new-transaction-amount" placeholder="Amount"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="-999999" step="0.01"/>
                        <input type="text" id="new-transaction-description" placeholder="Description"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <select id="transaction-budget-select" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <input type="datetime-local" id="new-transaction-date"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" />
                        <button id="add-transaction-button" class="btn btn-primary mb-3">Add Transaction</button>
                    </div>

                    <!-- Edit Transaction Form -->
                    <div id="edit-transaction-form" style="display:none; margin-bottom: 20px;">
                        <input type="number" id="edit-transaction-amount" placeholder="Amount"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" min="0" step="0.01"/>
                        <input type="text" id="edit-transaction-description" placeholder="Description"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;"/>
                        <select id="edit-transaction-budget-select" class="form-control mb-2"
                                style="max-width: 300px; display: inline-block;"></select>
                        <input type="datetime-local" id="edit-transaction-date"
                               class="form-control mb-2" style="max-width: 300px; display: inline-block;" />
                        <button class="btn btn-success" onclick="submitEditTransaction()">Save</button>
                        <button class="btn btn-secondary" onclick="cancelEditTransaction()">Cancel</button>
                    </div>

                    <!-- Transactions Table -->
                    <table class="table table-bordered" id="transactions-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Transaction Description</th>
                            <th>Budget Name</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>


            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>

<script>
    // Sections and navigation Items elements
    const sections = ['dashboard-section', 'users-section', 'budgets-section', 'categories-section', 'transactions-section'];
    const navItems = ['nav-item-dashboard', 'nav-item-users', 'nav-item-budgets', 'nav-item-categories', 'nav-item-transactions'];


    // "Local Cache" for FrontEnd
    let users = [];
    let categories = [];
    let budgets = [];
    let transactions = [];

    //Save the currentUser in local storage for refreshing purposes
    let currentUserId = localStorage.getItem('currentUserId') || null;

    // ID of the item that`s being edited
    let editingUserId = null;
    let editingCategoryId = null;
    let editingBudgetId = null;
    let editingTransactionId = null;

    // Showing the chosen section and hiding the others
    function showSection(sectionId) {
        // Validate sectionId type and existence in sections array
        if (typeof sectionId !== 'string' || !sections.includes(sectionId)) {
            console.warn(`showSection: Invalid sectionId "${sectionId}"`);
            return;
        }

        // Show the chosen section and hide the others
        sections.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (id === sectionId) ? 'block' : 'none';
            } else {
                console.warn(`showSection: Element with id "${id}" not found in DOM.`);
            }
        });

        // Extract the prefix safely from sectionId
        const prefix = sectionId.split('-')[0] || '';

        // Highlight the active navigation item
        navItems.forEach(navId => {
            const navEl = document.getElementById(navId);
            if (navEl) {
                navEl.classList.toggle(
                    'active',
                    navId === 'nav-item-' + prefix
                );
            } else {
                console.warn(`showSection: Navigation element with id "${navId}" not found in DOM.`);
            }
        });
    }

    // Listeners for the sidebar (with validation)
    const sidebarLinks = document.querySelectorAll('#accordionSidebar .nav-link');

    if (!sidebarLinks || sidebarLinks.length === 0) {
        console.warn('Sidebar links not found');
    } else {
        sidebarLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();

                const span = link.querySelector('span');
                if (!span) {
                    console.warn('Sidebar link span element missing');
                    return;
                }

                const sectionName = span.textContent?.trim().toLowerCase();
                if (!sectionName) {
                    console.warn('Sidebar link section name missing or empty');
                    return;
                }

                switch (sectionName) {
                    case 'dashboard':
                        showSection('dashboard-section');
                        break;
                    case 'users':
                        showSection('users-section');
                        loadUsers();
                        break;
                    case 'budgets':
                        showSection('budgets-section');
                        loadBudgets();
                        break;
                    case 'categories':
                        showSection('categories-section');
                        loadCategories();
                        break;
                    case 'transactions':
                        showSection('transactions-section');
                        fetchTransactions();
                        break;
                    default:
                        console.warn(`Unknown section name: ${sectionName}`);
                }
            });
        });
    }

    // --- USERS ---

    async function loadUsers() {
        try {
            // Fetch the list of users from the API
            const response = await fetch('http://localhost:8080/api/users');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Parse response JSON into the users array
            users = await response.json();

            // Find the table body element where users will be displayed
            const tbody = document.querySelector('#users-table tbody');
            if (!tbody) {
                console.warn('Table body for users not found');
                return;
            }
            tbody.innerHTML = ''; // Clear existing rows

            // For each user, create a table row with data and action buttons
            users.forEach(user => {
                const row = document.createElement('tr');

                // Create cells for user ID and username
                const tdId = document.createElement('td');
                tdId.textContent = user.id;
                const tdUsername = document.createElement('td');
                tdUsername.textContent = user.username;

                // Create actions cell with Delete, Edit, and Select buttons
                const tdActions = document.createElement('td');

                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-danger btn-sm';
                btnDelete.textContent = 'Delete';
                btnDelete.addEventListener('click', () => deleteUser(user.id));

                const btnEdit = document.createElement('button');
                btnEdit.textContent = 'Edit';
                btnEdit.addEventListener('click', () => editUser(user.id, user.username));

                const btnSelect = document.createElement('button');
                btnSelect.textContent = 'Select';
                btnSelect.addEventListener('click', () => changeCurrentUser(user.id));

                // Append buttons to the actions cell
                tdActions.append(btnDelete, btnEdit, btnSelect);

                // Append all cells to the row
                row.append(tdId, tdUsername, tdActions);

                // Append the row to the table body
                tbody.appendChild(row);
            });

            // If currentUserId is not set or no longer valid, set it to first user ID or null
            if (!currentUserId || !Array.isArray(users) || !users.some(u => u.id == currentUserId)) {
                currentUserId = Array.isArray(users) && users.length ? users[0].id : null;
                localStorage.setItem('currentUserId', currentUserId);
            }

            // Update UI to reflect current user and notify other parts of app
            updateCurrentUserDisplay();
            onCurrentUserChanged();

        } catch (error) {
            console.error('ERROR: Could not load the users:', error);
        }
    }

    async function addUser() {
        // Get and trim username input value
        const usernameInput = document.getElementById('new-user-username');
        const username = usernameInput ? usernameInput.value.trim() : '';

        // Validate input is not empty
        if (!username) {
            alert('Username cannot be empty.');
            return;
        }

        try {
            // Send POST request to add new user
            const response = await fetch('http://localhost:8080/api/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username })
            });

            // Check if response was successful
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Clear input field after successful addition
            if (usernameInput) {
                usernameInput.value = '';
            }

            // Reload users to update the list
            loadUsers();

        } catch (error) {
            console.error('ERROR: Could not add user:', error);
            alert('Failed to add user. Please try again.');
        }
    }

    async function deleteUser(id) {
        // Validate that id is provided
        if (!id) {
            console.warn('No user ID provided for deletion.');
            return;
        }

        // Confirm user wants to delete
        if (!confirm('Are you sure you want to delete this user?')) return;

        try {
            // Send DELETE request to API for the specified user ID
            const response = await fetch(`http://localhost:8080/api/users/${id}`, { method: 'DELETE' });

            // Check if deletion was successful
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Reload users to update the list after deletion
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not delete user:', error);
            alert('Failed to delete user. Please try again.');
        }
    }

    function editUser(id, username) {
        // Set the editing user ID (used internally for updating)
        editingUserId = id;

        // Populate the username input field with the current username
        const editInput = document.getElementById('edit-user-username');
        if (editInput) {
            editInput.value = username;
        } else {
            console.warn('Edit input element not found.');
            return;
        }

        // Show the edit user form
        const editForm = document.getElementById('edit-user-form');
        if (editForm) {
            editForm.style.display = 'block';
        }

        // Hide the new user input and add button while editing
        const newUserInput = document.getElementById('new-user-username');
        if (newUserInput) newUserInput.style.display = 'none';

        const addUserButton = document.getElementById('add-user-button');
        if (addUserButton) addUserButton.style.display = 'none';
    }

    function cancelEditUser() {
        // Clear the editing user ID (exit edit mode)
        editingUserId = null;

        // Hide the edit form
        const editForm = document.getElementById('edit-user-form');
        if (editForm) editForm.style.display = 'none';

        // Show the new user input field
        const newUserInput = document.getElementById('new-user-username');
        if (newUserInput) newUserInput.style.display = 'block';

        // Show the add user button
        const addUserButton = document.getElementById('add-user-button');
        if (addUserButton) addUserButton.style.display = 'inline-block';
    }

    async function submitEditUser() {
        // Get the new username from the edit field
        const newUsername = document.getElementById('edit-user-username').value.trim();

        // If no username provided or no user is being edited, stop
        if (!newUsername || !editingUserId) return;

        try {
            // Send PUT request to update the user
            await fetch(`http://localhost:8080/api/users/${editingUserId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: newUsername })
            });

            // Exit edit mode and reload user list
            cancelEditUser();
            loadUsers();
        } catch (error) {
            console.error('ERROR: Could not edit user:', error);
        }
    }

    function updateCurrentUserDisplay() {
        // Find the current user by ID
        const user = users.find(u => u.id == currentUserId);

        // Update the display element with the username or 'None' if not found
        const currentUsernameElement = document.getElementById('current-username');
        if (currentUsernameElement) {
            currentUsernameElement.textContent = user ? user.username : 'None';
        }
    }

    function changeCurrentUser(id) {
        // Update the current user ID in memory
        currentUserId = id;

        // Save the current user ID to localStorage for persistence
        localStorage.setItem('currentUserId', id);

        // Update the UI display with the new user's information
        updateCurrentUserDisplay();

        // Call a function to handle any additional logic when the user changes
        onCurrentUserChanged();
    }

    // --- CATEGORIES ---

    async function loadCategories() {
        // Check if current user ID is set
        if (!currentUserId) {
            clearCategoriesUI();
            return;
        }

        try {
            // Fetch categories for the current user from API
            const response = await fetch(`http://localhost:8080/api/categories/user/${currentUserId}`);

            // Validate the response status
            if (!response.ok) {
                throw new Error(`Failed to fetch categories: ${response.status} ${response.statusText}`);
            }

            categories = await response.json();

            // Clear the existing categories table body
            const tbody = document.querySelector('#categories-table tbody');
            if (!tbody) {
                throw new Error('Categories table body element not found');
            }
            tbody.innerHTML = '';

            // Populate table with categories
            categories.forEach(cat => {
                // Escape single quotes in the category name for safe HTML attribute usage
                const safeName = cat.name.replace(/'/g, "\\'");
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${cat.id}</td>
                <td>${cat.name}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteCategory('${cat.id}')">Delete</button>
                    <button onclick="editCategory('${cat.id}', '${safeName}')">Edit</button>
                </td>
            `;
                tbody.appendChild(row);
            });

            // Update category selects or other related UI elements
            fillCategorySelects();
        } catch (error) {
            // Log any errors that occurred during fetch or DOM manipulation
            console.error('ERROR: Could not load categories:', error);
        }
    }

    function clearCategoriesUI() {
        // Clear the categories table body content
        const tbody = document.querySelector('#categories-table tbody');
        if (tbody) tbody.innerHTML = '';

        // Clear the budget category select options
        const budgetCategorySelect = document.getElementById('budget-category');
        if (budgetCategorySelect) budgetCategorySelect.innerHTML = '';

        // Clear the edit budget category select options
        const editBudgetCategorySelect = document.getElementById('edit-budget-category');
        if (editBudgetCategorySelect) editBudgetCategorySelect.innerHTML = '';
    }

    function fillCategorySelects() {
        // Get the select elements for adding and editing budgets
        const addSelect = document.getElementById('budget-category');
        const editSelect = document.getElementById('edit-budget-category');

        // Validate that the select elements exist before proceeding
        if (!addSelect || !editSelect) {
            console.error('ERROR: Category select elements not found.');
            return;
        }

        // Clear existing options
        addSelect.innerHTML = '';
        editSelect.innerHTML = '';

        // Populate both selects with current categories
        categories.forEach(cat => {
            // Create option for addSelect
            const option1 = document.createElement('option');
            option1.value = cat.id;
            option1.textContent = cat.name;
            addSelect.appendChild(option1);

            // Clone the option for editSelect
            const option2 = option1.cloneNode(true);
            editSelect.appendChild(option2);
        });
    }

    async function addCategory() {
        // Get the new category name from input and trim whitespace
        const name = document.getElementById('new-category-name')?.value.trim();

        // Validate that name is not empty and currentUserId is set
        if (!name) {
            console.warn('WARNING: Category name is empty.');
            return;
        }
        if (!currentUserId) {
            console.error('ERROR: No current user selected.');
            return;
        }

        try {
            // Send POST request to add a new category
            await fetch('http://localhost:8080/api/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, user: { id: currentUserId } })
            });

            // Clear input after successful add
            document.getElementById('new-category-name').value = '';

            // Reload categories to update UI
            loadCategories();
        } catch (error) {
            console.error('ERROR: Could not add category:', error);
        }
    }

    async function deleteCategory(id) {
        // Confirm user really wants to delete the category
        if (!id) {
            console.warn('WARNING: No category ID provided for deletion.');
            return;
        }
        if (!confirm('Are you sure you want to delete this category?')) return;

        try {
            // Send DELETE request to backend to remove the category by id
            await fetch(`http://localhost:8080/api/categories/${id}`, { method: 'DELETE' });

            // Reload categories list after successful deletion
            loadCategories();
        } catch (error) {
            // Log any errors during the deletion process
            console.error('ERROR: Could not delete category:', error);
        }
    }

    function editCategory(id, name) {
        // Store the ID of the category being edited
        editingCategoryId = id;

        // Pre-fill the edit form input with the current category name
        document.getElementById('edit-category-name').value = name;

        // Show the edit category form
        document.getElementById('edit-category-form').style.display = 'block';

        // Hide the new category input field
        document.getElementById('new-category-name').style.display = 'none';

        // Hide the add category button
        document.getElementById('add-category-button').style.display = 'none';
    }

    function cancelEditCategory() {
        // Reset the editing category ID since editing is canceled
        editingCategoryId = null;

        // Hide the edit category form
        document.getElementById('edit-category-form').style.display = 'none';

        // Show the new category input field
        document.getElementById('new-category-name').style.display = 'block';

        // Show the add category button
        document.getElementById('add-category-button').style.display = 'inline-block';
    }

    async function submitEditCategory() {
        // Get the trimmed new category name from input
        const newName = document.getElementById('edit-category-name').value.trim();

        // Return early if no name or no category is currently being edited
        if (!newName || !editingCategoryId) return;

        try {
            // Send PUT request to update category on backend
            await fetch(`http://localhost:8080/api/categories/${editingCategoryId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: newName, user: { id: currentUserId } })
            });

            // Cancel edit mode and reload categories list
            cancelEditCategory();
            loadCategories();
        } catch (error) {
            // Log any errors during the update
            console.error('ERROR: Could not edit category:', error);
        }
    }

    // --- BUDGETS ---

    async function loadBudgets() {
        if (!currentUserId) {
            clearBudgetsUI();
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`);
            budgets = await response.json();

            console.log('Budgets loaded:', budgets); // pro kontrolu v konzoli

            const tbody = document.querySelector('#budgets-table tbody');
            tbody.innerHTML = '';

            budgets.forEach(budget => {
                // Ověření, zda category existuje a má name
                const categoryName = budget.category && budget.category.name ? budget.category.name : 'N/A';

                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${budget.id}</td>
                <td>${budget.name}</td>
                <td>${budget.limitAmount}</td>
                <td>${categoryName}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="deleteBudget('${budget.id}')">Delete</button>
                    <button onclick="editBudget('${budget.id}', '${budget.name}', ${budget.limitAmount}, '${budget.category ? budget.category.id : ''}')">Edit</button>
                </td>
            `;
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('ERROR: Could not load budgets:', error);
        }
    }

    function clearBudgetsUI() {
        document.querySelector('#budgets-table tbody').innerHTML = '';
    }

    async function addBudget() {
        const name = document.getElementById('new-budget-name').value.trim();
        const limitAmount = parseFloat(document.getElementById('new-budget-limit').value);
        const categoryId = document.getElementById('budget-category').value;

        if (!name || isNaN(limitAmount) || !categoryId || !currentUserId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        try {
            await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId },
                    user: { id: currentUserId }
                })
            });
            clearBudgetForm();
            loadBudgets();
            await loadBudgetsForTransactionSelect('transaction-budget-select');
            await loadBudgetsForTransactionSelect('edit-transaction-budget-select');
        } catch (error) {
            console.error('ERROR: Could not add budget:', error);
        }
    }

    function clearBudgetForm() {
        document.getElementById('new-budget-name').value = '';
        document.getElementById('new-budget-limit').value = '';
        document.getElementById('budget-category').selectedIndex = 0;
    }


    async function deleteBudget(id) {
        if (!confirm('Are you sure you want to delete this budget?')) return;

        try {
            await fetch(`http://localhost:8080/api/budgets/${id}`, { method: 'DELETE' });
            loadBudgets();
        } catch (error) {
            console.error('ERROR: Could not delete budget:', error);
        }
    }

    function editBudget(id, name, limitAmount, categoryId) {
        editingBudgetId = id;
        document.getElementById('edit-budget-name').value = name;
        document.getElementById('edit-budget-limit').value = limitAmount;
        document.getElementById('edit-budget-category').value = categoryId;

        document.getElementById('edit-budget-form').style.display = 'block';
        document.getElementById('add-budget-form').style.display = 'none';
    }

    function cancelEditBudget() {
        editingBudgetId = null;
        document.getElementById('edit-budget-form').style.display = 'none';
        document.getElementById('add-budget-form').style.display = 'block';
    }

    async function submitEditBudget() {
        const name = document.getElementById('edit-budget-name').value.trim();
        const limitAmount = parseFloat(document.getElementById('edit-budget-limit').value);
        const categoryId = document.getElementById('edit-budget-category').value;

        if (!name || isNaN(limitAmount) || !categoryId || !editingBudgetId) {
            alert('Please fill all budget fields correctly.');
            return;
        }

        try {
            await fetch(`http://localhost:8080/api/budgets/${editingBudgetId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    limitAmount,
                    category: { id: categoryId }
                })
            });
            cancelEditBudget();
            loadBudgets();
        } catch (error) {
            console.error('ERROR: Could not edit budget:', error);
        }
    }

    //Transactions

    // --- Helper pro vykreslení seznamu budgetů do <select> ---
    function renderBudgetOptions(selectElem) {
        selectElem.innerHTML = budgets
            .map(b => `<option value="${b.id}">${b.name}</option>`)
            .join('');
    }

    // --- Načtení transakcí z API a vykreslení ---
    async function fetchTransactions() {
        if (!currentUserId) {
            console.warn('No currentUserId set');
            return;
        }
        const res = await fetch(`http://localhost:8080/api/transactions/user/${currentUserId}`);
        if (!res.ok) {
            console.error('Failed to load transactions:', res.status);
            return;
        }
        transactions = await res.json();
        renderTransactionsTable();
    }

    // --- Vykreslení tabulky transakcí ---
    function renderTransactionsTable() {
        const tbody = document.querySelector('#transactions-table tbody');
        tbody.innerHTML = transactions
            .map(t => `
      <tr>
        <td>${t.id}</td>
        <td>${t.amount.toFixed(2)}</td>
        <td>${t.description}</td>
        <td>${t.budget ? t.budget.name : ''}</td>
        <td>${t.date}</td>  <!-- Přidej datum sem -->
        <td>
          <button class="btn btn-sm btn-primary" onclick="startEditTransaction('${t.id}')">Edit</button>
<button class="btn btn-sm btn-danger" onclick="deleteTransaction('${t.id}')">Delete</button>
        </td>
      </tr>
    `).join('');
    }

    // --- Přidání nové transakce ---
    async function addTransaction() {
        const amount = parseFloat(document.getElementById('new-transaction-amount').value);
        const description = document.getElementById('new-transaction-description').value.trim();
        const budgetId = document.getElementById('transaction-budget-select').value;
        const date = document.getElementById('new-transaction-date').value;

        if (isNaN(amount) || amount === 0 || description === '' || !date) {
            alert('Please fill all fields including date.');
            return;
        }

        try {
            const res = await fetch(`http://localhost:8080/api/transactions/user/${currentUserId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    amount,
                    description,
                    budget: { id: budgetId },
                    user: { id: currentUserId },
                    date
                })
            });
            if (!res.ok) throw new Error('Failed to add transaction');
            const newTransaction = await res.json();
            transactions.push(newTransaction);
            renderTransactionsTable();
            clearAddTransactionForm();
            loadBudgetsWithRemaining();
        } catch (e) {
            alert(e.message);
        }
    }

    function clearAddTransactionForm() {
        document.getElementById('new-transaction-amount').value = '';
        document.getElementById('new-transaction-description').value = '';
        document.getElementById('transaction-budget-select').selectedIndex = 0;
    }

    // --- Start editace transakce ---
    async function startEditTransaction(id) {
        const t = transactions.find(tr => tr.id === id);
        if (!t) return;

        editingTransactionId = id;

        document.getElementById('edit-transaction-amount').value = t.amount;
        document.getElementById('edit-transaction-description').value = t.description;

        await loadBudgetsForTransactionSelect('edit-transaction-budget-select');

        document.getElementById('edit-transaction-budget-select').value = t.budget.id;

        document.getElementById('add-transaction-form').style.display = 'none';
        document.getElementById('edit-transaction-form').style.display = 'block';
    }

    // --- Odeslání editace ---
    async function submitEditTransaction() {
        const amount = parseFloat(document.getElementById('edit-transaction-amount').value);
        const description = document.getElementById('edit-transaction-description').value.trim();
        const budgetId = document.getElementById('edit-transaction-budget-select').value;
        const date = document.getElementById('edit-transaction-date').value; // <- tady datum z edit inputu

        if (isNaN(amount) || amount <= 0 || description === '' || !date || !editingTransactionId) {
            alert('Please enter valid amount, description, date, and make sure transaction ID is set.');
            return;
        }

        const bodyData = {
            amount,
            description,
            budget: { id: budgetId },
            user: { id: currentUserId },
            date  // použij přímo datum z inputu
        };

        console.log('PUT /api/transactions body:', JSON.stringify(bodyData));

        try {
            const res = await fetch(`http://localhost:8080/api/transactions/${editingTransactionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyData)
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`Failed to update transaction. Server responded: ${text}`);
            }

            const updatedTransaction = await res.json();

            const idx = transactions.findIndex(t => t.id === editingTransactionId);
            if (idx >= 0) {
                transactions[idx] = updatedTransaction;
                renderTransactionsTable();
                cancelEditTransaction();
            }
        } catch (e) {
            alert(e.message);
        }
    }

    // --- Zrušení editace ---
    function cancelEditTransaction() {
        editingTransactionId = null;
        document.getElementById('edit-transaction-form').style.display = 'none';
        document.getElementById('add-transaction-form').style.display = 'block';
    }

    // --- Smazání transakce ---
    async function deleteTransaction(id) {
        if (!confirm('Are you sure you want to delete this transaction?')) return;
        try {
            const res = await fetch(`http://localhost:8080/api/transactions/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete transaction');
            transactions = transactions.filter(t => t.id !== id);
            renderTransactionsTable();
        } catch (e) {
            alert(e.message);
        }
    }

    // --- Inicializace na začátku ---
    async function initTransactionsSection() {
        // načti budgety do obou selectů podle aktuálního uživatele
        await loadBudgetsForTransactionSelect('transaction-budget-select');
        await loadBudgetsForTransactionSelect('edit-transaction-budget-select');

        await fetchTransactions();

        document.getElementById('add-transaction-button').onclick = addTransaction;
    }


    async function loadBudgetsForTransactionSelect(selectId) {
        if (!currentUserId) return;

        try {
            const response = await fetch(`http://localhost:8080/api/budgets/user/${currentUserId}`);
            const userBudgets = await response.json();

            const select = document.getElementById(selectId);
            select.innerHTML = '';

            userBudgets.forEach(budget => {
                const option = document.createElement('option');
                option.value = budget.id;
                option.textContent = budget.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('ERROR: Could not load budgets for transaction select:', error);
        }
    }

    function renderBudgetProgressBars(budgets) {
        const container = document.getElementById('budget-progress-bars');
        container.innerHTML = '';

        budgets.forEach(budget => {
            const spent = budget.limitAmount - budget.remainingAmount;
            const percent = Math.min((spent / budget.limitAmount) * 100, 100).toFixed(0);
            const color = percent < 70 ? 'bg-success' : percent < 100 ? 'bg-warning' : 'bg-danger';

            const progressBar = `
      <h4 class="small font-weight-bold">
        ${budget.name} — <small class="text-muted">${budget.category.name}</small>
        <span class="float-right">
          ${spent.toFixed(2)} Kč / ${budget.limitAmount.toFixed(2)} Kč
        </span>
      </h4>
      <div class="progress mb-4">
        <div class="progress-bar ${color}" role="progressbar"
             style="width: ${percent}%" aria-valuenow="${percent}"
             aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
    `;

            container.innerHTML += progressBar;
        });
    }

    async function loadBudgetsWithRemaining() {
        if (!currentUserId) {
            console.error('currentUserId není nastavený');
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/budgets/remaining?userId=${currentUserId}`);
            if (!response.ok) throw new Error('Chyba při načítání budgetů');
            const budgets = await response.json();

            console.log('Budgets with remaining:', budgets);
            renderBudgetProgressBars(budgets);
        } catch (error) {
            console.error('Chyba:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadBudgetsWithRemaining();
        setInterval(loadBudgetsWithRemaining, 10000);
    });

    // Volá se vždy po změně currentUserId
    async function onCurrentUserChanged() {
        loadCategories();
        loadBudgets();
        fillCategorySelects();
        await initTransactionsSection();
        loadBudgetsWithRemaining();
    }

    window.onload = async () => {
        showSection('dashboard-section');
        await loadUsers();
    };
</script>
</body>
</html>